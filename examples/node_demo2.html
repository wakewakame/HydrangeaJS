<!DOCTYPE html>
<html>
<head>
	<!-- Select Text Encode -->
	<meta content="ja" http-equiv="Content-Language" />
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
	<!-- Set Resolution -->
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!-- full screen on iOS browser -->
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<!-- title -->
	<title>NodeShader</title>

	<script type="text/javascript" src="../dst/hydrangea.js"></script>
	<script src="https://pagecdn.io/lib/ace/1.4.5/ace.js" integrity="sha256-5Xkhn3k/1rbXB+Q/DX/2RuAtaB4dRRyQvMs83prFjpM=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		const RootComponent = HydrangeaJS.GUI.Component.RootComponent;
		const NodeCanvas = HydrangeaJS.GUI.Templates.NodeCanvas;
		const TimeNode = HydrangeaJS.Extra.ShaderNode.TimeNode;
		const PictureNode = HydrangeaJS.Extra.ShaderNode.PictureNode;
		const ShaderNode = HydrangeaJS.Extra.ShaderNode.ShaderNode;
		const FrameNode = HydrangeaJS.Extra.ShaderNode.FrameNode;

		const Applet = class {
			constructor(canvas) {
				this.fps = 60.0;

				this.root = new RootComponent(canvas);
				window.addEventListener("resize", (e) => {
					this.root.graphics.resize(window.innerWidth, window.innerHeight);
				});
				this.root.graphics.resize(window.innerWidth, window.innerHeight);

				const NodeCanvasExt = class extends NodeCanvas{
					constructor(canvasElement) {
						super();
						this.editorElement = document.createElement("div");
						canvasElement.parentNode.appendChild(this.editorElement);
						this.editorElement.id = "shader_editor";
						this.editorElement.style["position"] = "fixed";
						this.editorElement.style["left"] = "0%";
						this.editorElement.style["top"] = "50%";
						this.editorElement.style["width"] = "100%";
						this.editorElement.style["height"] = "50%";
						this.editorElement.style["background"] = "#FFFFFF80";
						this.editorElement.style["display"] = "none";

						this.editor = ace.edit(this.editorElement.id);
						this.editor.setTheme("ace/theme/tomorrow");
						this.editor.setOptions({
							fontSize: "14pt"
						});
						this.editor.getSession().setMode("ace/mode/glsl");
						this.editor.on("change", (e) => {
							if (this.childs.length > 0) {
								if (this.childs[0] instanceof ShaderNode) {
									const code = this.editor.getValue();
									if (
										code !== "" &&
										code !== this.childs[0].compileState.code
									) this.childs[0].loadShader(code);
								}
							}
						});
					}
					mouseEvent(type, x, y, start_x, start_y){
						super.mouseEvent(type, x, y, start_x, start_y);
						if (type === "DOWN") this.editorElement.style["pointer-events"] = "none";
						if (type === "UP")   this.editorElement.style["pointer-events"] = "auto";
						if (type === "DOWN") {
							this.editorElement.style["display"] = "none";
							if (this.childs.length > 0 && this.childs[0] instanceof ShaderNode && this.childs[0].checkHit(x, y)) {
								this.editorElement.style["display"] = "inline";
								this.editor.setValue(this.childs[0].compileState.code);
								this.editor.gotoLine(1, 0);
							}
						}
					}
				};

				this.nodeCanvas = new NodeCanvasExt(this.root.graphics.gapp.canvas);
				this.root.add(this.nodeCanvas);

				let node0 = this.nodeCanvas.add(new TimeNode(30 + 250 * 0, 300));
				let node1 = this.nodeCanvas.add(new PictureNode("lenna", "./lenna.png", 30 + 250 * 0, 30));
				let node2 = this.nodeCanvas.add(new ShaderNode  ("rotate", 30 + 250 * 1, 150));
				let node3 = this.nodeCanvas.add(new FrameNode  ("result1", 30 + 250 * 2, 30, 512, 512));
				let node4 = this.nodeCanvas.add(new ShaderNode  ("colorful", 30 + 250 * 3, 150));
				let node5 = this.nodeCanvas.add(new FrameNode  ("result2", 30 + 250 * 4, 30, 512, 512));

				node2.loadShader(
`precision highp float;
uniform sampler2D texture;
uniform vec2 texture_resolution;
uniform float time;
varying vec2 vUv;

void main(void){
	vec2 area = vec2(
		texture_resolution.x / exp2(ceil(log2(texture_resolution.x))),
		texture_resolution.y / exp2(ceil(log2(texture_resolution.y)))
	);
	vec2 p = vUv * area;
	p -= area * 0.5;
	p *= mat2(cos(time), -sin(time), sin(time), cos(time));
	p += area * 0.5;
	gl_FragColor = texture2D(texture, p);
}`
				);

				node4.loadShader(
`precision highp float;
uniform sampler2D texture;
uniform vec2 texture_resolution;
varying vec2 vUv;

void main(void){
	vec2 area = vec2(
		texture_resolution.x / exp2(ceil(log2(texture_resolution.x))),
		texture_resolution.y / exp2(ceil(log2(texture_resolution.y)))
	);
	vec2 p = vUv * area;
	gl_FragColor = texture2D(texture, p);
	gl_FragColor.rgb += vec3(p.x, 1.0 - sqrt(p.x * p.x + p.y * p.y), p.y);
}`
				);

				node2.inputs.childs[0].output = node1.outputs.childs[0];
				node2.inputs.childs[1].output = node1.outputs.childs[1];
				node2.inputs.childs[2].output = node0.outputs.childs[0];
				node3.inputs.childs[0].output = node2.outputs.childs[0];
				node4.inputs.childs[0].output = node3.outputs.childs[0];
				node4.inputs.childs[1].output = node3.outputs.childs[1];
				node5.inputs.childs[0].output = node4.outputs.childs[0];
				this.nodeCanvas.activeChilds(node5);

				document.body.addEventListener('dragover', (e) => {
					e.stopPropagation();
					e.preventDefault();
					e.dataTransfer.dropEffect = 'copy';
				}, false);
				document.body.addEventListener("drop", (e) => {
					e.stopPropagation();
					e.preventDefault();
					for(let file of e.dataTransfer.files) {
						let url = window.URL.createObjectURL(file);
						this.nodeCanvas.add(new PictureNode(file.name, url, 30 + 170 * 0, 30));
					}
				}, false);

				this.loop();
			}

			loop() {
				this.root.graphics.clear();

				this.root.graphics.stroke(1.0, 1.0, 1.0, 0.0);
				this.root.graphics.fill(1.0, 1.0, 1.0, 1.0);
				this.root.graphics.rect(0, 0, this.root.w, this.root.h);

				this.nodeCanvas.reset();
				this.nodeCanvas.job();

				this.root.update();
				this.root.draw();

				setTimeout(this.loop.bind(this), 1000.0 / this.fps);
			}
		};
		document.addEventListener("DOMContentLoaded", (event) => {
			let canvas = document.getElementById("canvas");
			node_editor = new Applet(canvas);
		});
	</script>
</head>

<body style="position:fixed; top:0; left:0; width:100%; height:100%;">
	<canvas id="canvas" style="position:fixed; left:0; top:0; width:100%; height:100%;"></canvas>
</body>
</html>
