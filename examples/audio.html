<!DOCTYPE html>
<html>
<head>
	<!-- Select Text Encode -->
	<meta content="ja" http-equiv="Content-Language" />
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
	<!-- Set Resolution -->
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!-- full screen on iOS browser -->
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<!-- title -->
	<title>NodeShader</title>

	<script type="text/javascript" src="../dst/hydrangea.js"></script>
	<script src="https://pagecdn.io/lib/ace/1.4.5/ace.js" integrity="sha256-5Xkhn3k/1rbXB+Q/DX/2RuAtaB4dRRyQvMs83prFjpM=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		const Page = HydrangeaJS.GUI.Page.Page;
		const PageEvent = HydrangeaJS.GUI.Page.PageEvent;
		const NodeCanvas = HydrangeaJS.GUI.Templates.NodeCanvas;
		const TimeNode = HydrangeaJS.Extra.ShaderNode.TimeNode;
		const PictureNode = HydrangeaJS.Extra.ShaderNode.PictureNode;
		const ShaderNode = HydrangeaJS.Extra.ShaderNode.ShaderNode;
		const FrameNode = HydrangeaJS.Extra.ShaderNode.FrameNode;
		const ValueNode = HydrangeaJS.Extra.ShaderNode.ValueNode;
		const Audio = HydrangeaJS.Extra.Audio.Audio;

		const NodeCanvasExt = class extends NodeCanvas{
			constructor(page) {
				super();
				this.activeNode = null;
				this.editorElement = page.addElement("div", 0.0, 0.5, 1.0, 1.0, {
					"background": "#FFFFFF80",
					"display": "none"
				});
				this.editorElement.id = "shader_editor";
				this.editor = ace.edit(this.editorElement.id);
				this.editor.setTheme("ace/theme/tomorrow");
				this.editor.setOptions({
					fontSize: "14pt"
				});
				this.editor.getSession().setMode("ace/mode/glsl");
				this.editor.on("change", (e) => {
					if (this.childs.length > 0) {
						if (this.childs[0].hasOwnProperty("compileState")) {
							const code = this.editor.getValue();
							if (
								code !== "" &&
								code !== this.childs[0].compileState.code
							) this.childs[0].setCode(code);
						}
					}
				});
				this.addEventListener("DOWN", e => {
					this.activeNode = null;
					this.editorElement.style["display"] = "none";
				});
				this.audio = null;
				this.audioInput = null;
				this.audioOutput = null;
			}
			setup(){
				const AudioInputNode = class extends FrameNode {
					constructor(x, y, array_length) {
						super(
							"audio input",
							x, y, array_length, 1
						);
						this.inputWave = null;
					}
					setup() {
						super.setup();
						this.resizeFrame(
							this.frameBufferState.width, this.frameBufferState.height,
							this.graphics.gapp.gl.RGBA, this.graphics.gapp.gl.FLOAT
						);
						this.inputs.remove(this.inputShaderNodeParam);
						this.inputs.remove(this.inputResolutionNodeParam);
						this.previewShader.loadShader(this.previewShader.default_shader.vertex, `
precision highp float;
uniform sampler2D texture;
uniform ivec2 textureArea;
varying vec2 v_uv;

void main(void){
	vec2 p = v_uv * vec2(textureArea);
	float wave = texture2D(texture, p).r / 2.0;
	p.y = (p.y * 2.0) - 1.0;
	float g = (p.y > wave) ? 1.0 : 0.0;
	gl_FragColor = vec4(vec3(g), 1.0);
}
						`);
					}
					job() {
						super.job();
						if (this.inputWave instanceof Float32Array) {
							this.frameBuffer.texture.update(this.inputWave);
						}
					}
				}
				const AudioOutputNode = class extends FrameNode {
					constructor(x, y, array_length) {
						super(
							"audio output",
							x, y, array_length, 1
						);
					}
					setup() {
						super.setup();
						this.resizeFrame(
							this.frameBufferState.width, this.frameBufferState.height,
							this.graphics.gapp.gl.RGBA, this.graphics.gapp.gl.FLOAT
						);
						this.outputs.remove(this.outputShaderNodeParam);
						this.outputs.remove(this.outputResolutionNodeParam);
						this.inputs.remove(this.inputResolutionNodeParam);
						this.previewShader.loadShader(this.previewShader.default_shader.vertex, `
precision highp float;
uniform sampler2D texture;
uniform ivec2 textureArea;
varying vec2 v_uv;

void main(void){
	vec2 p = v_uv * vec2(textureArea);
	float wave = texture2D(texture, p).r / 2.0;
	p.y = (p.y * 2.0) - 1.0;
	float g = (p.y > wave) ? 1.0 : 0.0;
	gl_FragColor = vec4(vec3(g), 1.0);
}
						`);
					}
				}
				this.audio = new Audio();
				this.audioInput  = this.add(new AudioInputNode (30, 30, this.audio.array_length));
				this.audioOutput = this.add(new AudioOutputNode(530, 30, this.audio.array_length));
				this.audio.setCallback((input, output, inputSampleRate, outputSampleRate) => {
					const tmpArray = new Float32Array(input.length * 4);
					for (let i = 0; i < input.length; i++) {
						tmpArray[i * 4 + 0] = input[i];
						tmpArray[i * 4 + 1] = 1.0;
						tmpArray[i * 4 + 2] = 1.0;
						tmpArray[i * 4 + 3] = 1.0;
					}
					this.audioInput.inputWave = tmpArray;
					this.resetAndJob();
					this.audioOutput.frameBuffer.read(tmpArray)
					for (let i = 0; i < output.length; i++) {
						output[i] = tmpArray[i * 4 + 0];
					}
				});
				document.addEventListener("click", () => {
					this.audio.clickEvent();
				}, false);
			}
			add(component){
				const ret = super.add(component);
				component.addEventListener("DOWN", e => {
					this.activeNode = e.component;
					this.editorElement.style["display"] = "none";
					if (this.childs[0].hasOwnProperty("compileState")) {
						this.editorElement.style["display"] = "inline";
						this.editor.setValue(this.activeNode.compileState.code);
						this.editor.gotoLine(1, 0);
					}
				});
				return ret;
			}
		};

		const OriginalPageEvent = class extends PageEvent {
			constructor() {
				super();
				this.nodeCanvas = null;
			}
			init(page) {
				this.nodeCanvas = page.addComponent(new NodeCanvasExt(page));
				let node1 = this.nodeCanvas.add(new ShaderNode("copy", 30 + 250 * 1, 150, 500));
				let node2 = this.nodeCanvas.add(new ShaderNode("s1", 30 + 250 * 1, 350, 500));
				let node3 = this.nodeCanvas.add(new FrameNode("f1", 30 + 250 * 2, 350, 1024, 1024));
				let node4 = this.nodeCanvas.add(new ValueNode("ivec2", "v1", 30 + 250 * 1, 550, 500));

				node1.setCode(
`precision highp float;
uniform sampler2D texture;
uniform ivec2 texture_resolution;
varying vec2 v_uv;

void main(void){
	vec2 area = vec2(
		float(texture_resolution.x) / exp2(ceil(log2(float(texture_resolution.x)))),
		float(texture_resolution.y) / exp2(ceil(log2(float(texture_resolution.y))))
	);
	vec2 p = v_uv * area;
	float wave = texture2D(texture, p).r;
	gl_FragColor = vec4(wave, 0.0, 0.0, 1.0);
}`
				);

				node2.setCode(
`precision highp float;
uniform sampler2D texture;
uniform ivec2 texture_resolution;
varying vec2 v_uv;

void main(void){
	vec2 area = vec2(
		float(texture_resolution.x) / exp2(ceil(log2(float(texture_resolution.x)))),
		float(texture_resolution.y) / exp2(ceil(log2(float(texture_resolution.y))))
	);
	vec2 p = v_uv * area;
	float wave = texture2D(texture, p).r / 2.0;
	p.y = (p.y * 2.0) - 1.0;
	float g = (p.y > wave) ? 1.0 : 0.0;
	gl_FragColor = vec4(vec3(g), 1.0);
}`
				);
				node4.setCode('{"x": 1024, "y": 1024}');

				node1.inputs.childs[0].output = this.nodeCanvas.audioInput.outputs.childs[0];
				node1.inputs.childs[1].output = this.nodeCanvas.audioInput.outputs.childs[1];
				this.nodeCanvas.audioOutput.inputs.childs[0].output = node1.outputs.childs[0];
				node2.inputs.childs[0].output = this.nodeCanvas.audioInput.outputs.childs[0];
				node2.inputs.childs[1].output = this.nodeCanvas.audioInput.outputs.childs[1];
				node3.inputs.childs[0].output = node2.outputs.childs[0];
				node3.inputs.childs[1].output = node4.outputs.childs[0];
			}
			loop(page) {
				this.nodeCanvas.resetAndJob();
			}
			dropFiles(page, files) { console.log(files); }
		};

		const page = new Page(new OriginalPageEvent());
	</script>
</head>
<body>
</body>
</html>